<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>JMW Chat â€” Public â€¢ Groups â€¢ DMs</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="icon" href="/assets/images/jmw.png"/>
  <link rel="shortcut icon" href="/assets/images/jmw.png"/>
  <link rel="manifest" href="/manifest.json"/>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <style>
    @import url('/assets/css/themes.css');
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,sans-serif;background:var(--bgcolor);color:var(--txtcolor);height:100vh;display:flex}
    .sidebar{width:300px;max-width:38vw;background:var(--surface);border-right:1px solid var(--surface-hover);display:flex;flex-direction:column}
    .side-header{padding:12px 14px;font-weight:600;border-bottom:1px solid var(--surface-hover);display:flex;align-items:center;gap:8px;justify-content:space-between}
    .id-badge{font-size:12px;opacity:.7}
    .side-section{padding:10px 12px;border-bottom:1px solid var(--surface-hover)}
    .side-section h4{margin:0 0 8px 0;font-size:13px;opacity:.8}
    .pill{display:flex;gap:6px}
    .pill input{flex:1;padding:8px;border:1px solid var(--surface-hover);border-radius:8px;background:var(--surface);color:var(--txtcolor)}
    .pill button{padding:8px 10px;border:none;border-radius:8px;background:var(--surface-hover);color:var(--txtcolor);cursor:pointer}
    .list{overflow:auto;max-height:35vh;display:flex;flex-direction:column;gap:6px}
    .user{display:flex;justify-content:space-between;align-items:center;background:var(--bgcolor);padding:8px;border-radius:8px}
    .user .meta-id{display:block;font-size:11px;opacity:.6}
    .user .actions{display:flex;gap:6px}
    .user button{border:none;border-radius:6px;background:var(--surface-hover);color:var(--txtcolor);padding:4px 8px;cursor:pointer}
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .header{background:var(--surface-hover);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;font-weight:600}
    .header .right{display:flex;gap:8px;align-items:center}
    .header button{background:#dc3545;border:none;color:#fff;font-weight:600;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:.9rem}
    .tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--surface-hover);background:var(--surface)}
    .tab{padding:6px 10px;border-radius:8px;background:var(--bgcolor);cursor:pointer;user-select:none}
    .tab.active{outline:2px solid var(--surface-hover)}
    .panes{flex:1;display:flex;min-height:0}
    .pane{flex:1;display:none;flex-direction:column;min-width:0}
    .pane.active{display:flex}
    .chat-area{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:var(--bgcolor)}
    .message{display:flex;align-items:flex-start;gap:10px;padding:10px;background:black;border-radius:12px;max-width:70%;word-break:break-word;position:relative}
    .self{align-self:flex-end;background:var(--surface);color:var(--txtcolor)}
    .avatar{width:32px;height:32px;background:var(--surface-hover);color:var(--txtcolor);display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:bold;border-radius:50%;flex-shrink:0}
    .meta{font-size:12px;opacity:.7;margin-bottom:4px}
    .input-area{display:flex;gap:10px;padding:10px;background:var(--surface);border-top:1px solid var(--surface-hover)}
    .input-area input{flex:1;padding:10px;border:1px solid var(--surface-hover);border-radius:8px;background:var(--surface);color:var(--txtcolor)}
    .input-area button{padding:10px 12px;background:var(--surface);color:var(--txtcolor);border:none;border-radius:8px;cursor:pointer}
    .msg-delete{position:absolute;right:8px;top:8px;background:transparent;border:none;color:#f55;cursor:pointer;font-size:14px;padding:4px;border-radius:6px}
    #emojiList{display:none;flex-wrap:wrap;flex-direction:row;width:600px;position:fixed;bottom:70px;right:20px;background:var(--txtcolor);border:1px solid #ccc;border-radius:10px;padding:10px;box-shadow:0 0 10px rgba(0,0,0,.1);max-width:600px;gap:5px;z-index:1000}
    .centered{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,.25);backdrop-filter:blur(3px)}
    .modal{background:var(--bgcolor);padding:2rem;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.1);width:90%;max-width:800px;text-align:center}
    .modal input,.modal button{width:100%;padding:.8rem;margin-top:1rem;font-size:1rem;border:1px solid #ccc;border-radius:8px}
    .modal button{background:var(--surface-hover);color:var(--txtcolor);border:none;cursor:pointer}
    .row{display:flex;gap:10px}
    .row input{flex:1}
    .muted-note{font-size:12px;opacity:.7;margin-top:6px}
  </style>
</head>
<body theme="classic">
  <div class="centered" id="joinScreen">
    <div class="modal">
      <h2>JMW Chat</h2>
      <p>Public chat, group rooms, and direct messages.</p>
      <div class="row">
        <input style="background:var(--surface);" id="nameInput" placeholder="Enter your name" maxlength="50" autocomplete="off"/>
      </div>
      <div class="row">
        <input style="background:var(--surface);" id="roomInput" placeholder="Optional: enter group code (min 6 chars)" maxlength="32" autocomplete="off"/>
      </div>
      <button id="joinBtn">Enter</button>
      <p id="errorText" style="color:red;font-size:.9rem;border-radius:8px;"></p>
    </div>
  </div>

  <div class="sidebar">
    <div class="side-header">
      <div>
        <div id="meName">You</div>
        <div class="id-badge" id="meId"></div>
      </div>
      <div id="roleBadge" class="id-badge"></div>
    </div>

    <div class="side-section">
      <h4>Join/Create Group</h4>
      <div class="pill">
        <input id="joinGroupInput" placeholder="group code"/>
        <button id="joinGroupBtn">Join</button>
      </div>
      <div class="muted-note">Current: <span id="currentGroup">None</span></div>
    </div>

    <div class="side-section">
      <h4>Online Users</h4>
      <div class="list" id="userList"></div>
    </div>

    <div class="side-section" id="modPanel" style="display:none">
      <h4>Moderator Tools</h4>
      <div class="muted-note">Click a user â†’ choose Mute/Kick/Ban.</div>
    </div>
  </div>

  <div class="main">
    <div class="header">
      <div>JMW Chat â€¢ <span id="displayName"></span></div>
      <div class="right"><span id="userCount">0</span> online <button id="leaveBtn">Leave Chat</button></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-pane="publicPane">Public</div>
      <div class="tab" data-pane="groupPane">Group</div>
      <div class="tab" data-pane="dmPane">Direct</div>
    </div>

    <div class="panes">
      <div class="pane active" id="publicPane">
        <div class="chat-area" id="publicArea"></div>
        <div class="input-area">
          <input id="publicInput" placeholder="Message everyone..." maxlength="500" autocomplete="off"/>
          <button id="emojiBtnPublic" title="Emoji"><i class='bx bx-smile'></i></button>
          <button id="sendPublic">Send</button>
        </div>
      </div>

      <div class="pane" id="groupPane">
        <div class="chat-area" id="groupArea"></div>
        <div class="input-area">
          <input id="groupInput" placeholder="Message current group..." maxlength="500" autocomplete="off"/>
          <button id="emojiBtnGroup" title="Emoji"><i class='bx bx-smile'></i></button>
          <button id="sendGroup">Send</button>
        </div>
      </div>

      <div class="pane" id="dmPane">
        <div class="side-section" style="border:none">
          <div class="pill">
            <input id="dmToInput" placeholder="Recipient userId"/>
            <button id="dmPick" title="Pick from users">Pick</button>
          </div>
        </div>
        <div class="chat-area" id="dmArea"></div>
        <div class="input-area">
          <input id="dmInput" placeholder="Direct message..." maxlength="500" autocomplete="off"/>
          <button id="emojiBtnDm" title="Emoji"><i class='bx bx-smile'></i></button>
          <button id="sendDm">Send</button>
        </div>
      </div>
    </div>
  </div>

  <div id="emojiList"></div>

<script type="module">
let ws;
let username = '';
let roomCode = '';
let isRecording = false;
let recognition;
let isRoomCodeVisible = false;

// Emoji map (same as before)
const emojiMap = { smile: 'ðŸ˜„', heart: 'â¤ï¸', broken_heart: 'ðŸ’”', wilted_rose: 'ðŸ¥€', thumbsup: 'ðŸ‘', clap: 'ðŸ‘', fire: 'ðŸ”¥', grin: 'ðŸ˜', cry: 'ðŸ˜¢', angry: 'ðŸ˜ ', wink: 'ðŸ˜‰', star: 'â­', poop: 'ðŸ’©', ok: 'ðŸ‘Œ', joy: 'ðŸ˜‚', sob: 'ðŸ˜­', kiss: 'ðŸ˜˜', thinking: 'ðŸ¤”', hug: 'ðŸ¤—', pray: 'ðŸ™', cool: 'ðŸ˜Ž', sleepy: 'ðŸ˜´', shocked: 'ðŸ˜²', scream: 'ðŸ˜±', nerd: 'ðŸ¤“', blush: 'ðŸ˜Š', yum: 'ðŸ˜‹', devil: 'ðŸ˜ˆ', robot: 'ðŸ¤–', skull: 'ðŸ’€', alien: 'ðŸ‘½', sun: 'ðŸŒž', moon: 'ðŸŒ', cat: 'ðŸ±', dog: 'ðŸ¶', cake: 'ðŸŽ‚', balloon: 'ðŸŽˆ' };

// Sanitize input using DOMPurify
function sanitizeInput(text) {
  return DOMPurify.sanitize(text, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
}

// Emoji replacement
function replaceEmojis(text) {
  return text.replace(/:([a-z0-9_+-]+):/gi, (match, name) => emojiMap[name] || match);
}

// Message rendering
function renderMessage(text, name, isSelf, time) {
  const area = document.getElementById('chatArea');
  const message = document.createElement('div');
  message.className = 'message' + (isSelf ? ' self' : '');
  const avatarLetter = sanitizeInput(name.replace('ðŸ‘‘', '').trim().charAt(0).toUpperCase());
  const displayName = name.startsWith('ðŸ‘‘') ? `<strong>${sanitizeInput(name)}</strong>` : sanitizeInput(name);
  message.innerHTML = `
    <div class="avatar">${avatarLetter}</div>
    <div>
      <div class="meta">${displayName} â€¢ ${time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
      <div>${replaceEmojis(sanitizeInput(text))}</div>
    </div>
  `;
  area.appendChild(message);
  area.scrollTop = area.scrollHeight;
  saveMessages();
}

// Save/load messages to localStorage
const STORAGE_KEY = 'jmw_chatMessages';
function saveMessages() {
  const messages = Array.from(document.querySelectorAll('#chatArea .message')).map(m => m.outerHTML);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
}
function loadMessages() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return;
  const area = document.getElementById('chatArea');
  area.innerHTML = '';
  JSON.parse(saved).forEach(html => {
    const div = document.createElement('div');
    div.innerHTML = html;
    area.appendChild(div.firstElementChild);
  });
  area.scrollTop = area.scrollHeight;
}

// Connect to WSS
function startWS() {
  ws = new WebSocket(`ws://localhost:4141/wisp/`);
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'join', username, room: roomCode }));
    console.log('Connected to WSS');
  };
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'message') {
      const isSelf = data.name === username;
      renderMessage(data.text, data.name, isSelf, data.time);
    } else if (data.type === 'system') {
      renderMessage(data.message, 'System', false);
    }
  };
  ws.onclose = () => console.log('Disconnected from WSS');
  ws.onerror = (err) => console.error('WSS error', err);
}

// Send chat
function sendChat() {
  const input = document.getElementById('chatInput');
  const text = sanitizeInput(input.value.trim());
  if (!text) return;
  ws.send(JSON.stringify({ type: 'message', text }));
  input.value = '';
}

// Join chat
function joinChat() {
  const rawName = document.getElementById('nameInput').value.trim();
  const rawRoom = document.getElementById('roomInput').value.trim();
  if (!rawName || !rawRoom) return alert('Enter name and room code');
  username = rawName === 'galacticadmin' ? 'ðŸ‘‘ ' + rawName : rawName;
  roomCode = rawRoom;
  document.getElementById('displayName').textContent = username;
  document.getElementById('roomCodeMasked').textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢';
  document.getElementById('joinScreen').style.display = 'none';
  document.getElementById('chatUI').style.display = 'flex';
  startWS();
  loadMessages();
  localStorage.setItem('jmw_username', username);
  localStorage.setItem('jmw_roomCode', roomCode);
}

// Leave chat
function leaveChat() {
  if (ws) ws.close();
  document.getElementById('chatArea').innerHTML = '';
  document.getElementById('chatInput').value = '';
  document.getElementById('nameInput').value = '';
  document.getElementById('roomInput').value = '';
  document.getElementById('chatUI').style.display = 'none';
  document.getElementById('joinScreen').style.display = 'flex';
  localStorage.removeItem('jmw_username');
  localStorage.removeItem('jmw_roomCode');
  localStorage.removeItem(STORAGE_KEY);
}

// Toggle emoji list
function toggleEmojiList() {
  const list = document.getElementById('emojiList');
  if (list.style.display === 'none') {
    list.innerHTML = '';
    Object.entries(emojiMap).forEach(([name, symbol]) => {
      const btn = document.createElement('button');
      btn.textContent = symbol;
      btn.title = `:${name}:`;
      btn.onclick = () => { document.getElementById('chatInput').value += `:${name}:`; input.focus(); toggleEmojiList(); };
      list.appendChild(btn);
    });
    list.style.display = 'flex';
  } else {
    list.style.display = 'none';
  }
}

// Voice input
function toggleMic() {
  if (isRecording) { recognition.stop(); return; }
  if (!('webkitSpeechRecognition' in window)) return alert('Browser does not support speech recognition');
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-US';
  recognition.onstart = () => { isRecording = true; document.getElementById('micBtn').innerHTML = 'Recording..'; };
  recognition.onresult = e => { document.getElementById('chatInput').value = e.results[0][0].transcript; sendChat(); };
  recognition.onend = recognition.onerror = () => { isRecording = false; document.getElementById('micBtn').innerHTML = `<i class='bx bx-microphone'></i>`; };
  recognition.start();
}

// Show room code toggle
document.getElementById('roomCodeMasked').addEventListener('click', () => {
  const el = document.getElementById('roomCodeMasked');
  el.textContent = isRoomCodeVisible ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : roomCode;
  isRoomCodeVisible = !isRoomCodeVisible;
});

// Load saved username/room
window.addEventListener('DOMContentLoaded', () => {
  const savedName = localStorage.getItem('jmw_username');
  const savedRoom = localStorage.getItem('jmw_roomCode');
  if (savedName && savedRoom) { username = savedName; roomCode = savedRoom; joinChat(); }
});

// Send on enter
document.getElementById('chatInput').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendChat(); } });
</script>

  <script src="/assets/scripts/index.js"></script>
</body>
<script>
  var script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/eruda';
document.body.appendChild(script);
script.onload = function() { eruda.init(); };
</script>
</html>
